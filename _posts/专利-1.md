技术交底书

| 交底书名称   | 一种实时的视频人像背景替换与融合系统及方法 |          |                  |
| ------------ | ------------------------------------------ | -------- | ---------------- |
| 发明人       | 何帅、叶海佳、王文澜                       |          |                  |
| 撰写人及电话 | 何帅 15602334560                           | 相关产品 |                  |
| 相关部门     | AI基础中心                                 | E-mail   | heshuai@huya.com |

缩略语和关键术语定义

抠图：将一副图像中的前景信息和背景信息分离，给定图像$I$，假设抠图分离的前景和背景分别为$F$和$B$，则得到抠图的数学模型：
$$
I = \alpha F+(1-\alpha)B
$$
构图的过程即为求解上述方程，得到$F$、$B$和$\alpha$作为抠图结果。

### 1、 本发明所要解决的技术问题（发明目的）

本发明涉及互联网直播领域，通过精确的抠图技术，将人实体从其所在背景中扣离，实现给定虚拟背景替换和融合。具体技术问题包括：

1) 二阶指数平滑ROI跟踪。

2) 人像背景分离。

3) 背景融合。

4) 帧间稳定。

### 2、 相关技术背景，与本发明最相近似的现有实现方案

为实现人物背景替换，需要精确地将人实例从原有背景中分离出来。分离的方法主要有两种：人像语义分割和人像前景抠图。

#### （1）人像语义二值化分割

人像语义分割从语义层次理解图像，将在语义类属中归类为人的部分像素与归为背景部分的像素分离，得到一个0与1的掩膜。通过掩膜可以将人像部分区域抠离背景；
完整的分割算法流程需要考虑局部语意信息和像素级低层次信息。传统的分割算法多基于图论算法，分辨率增大会导致计算量的指数增加，且优化函数天然倾向于低层次特征，导致明显语意差别的相似区域被分割成一类。由于卷积具有强大的多维度（如图像中的2D）特征提取能力和抽象能力，深层CNN为分割提供了语意层次信息提取的可能。但基于CNN的分割本质是空间分类，相邻的像素点分类结果无图论节点间的强联合关系，无视物体的拓扑结构，导致容易出现游离脏块，且CNN的过度平滑效应使边缘拟合较差。目前的发展趋势是深度学习和图论算法结合，但推理计算量限制了该类算法的实时性应用。

#### （2）人像抠图

该方式相对人像语义分割精确到像素级别，并可以有效处理透明区域问题。通过求解公式（1），得到0到1的连续值掩膜。抠图算法要解决两个问题：求解图像像素点颜色分布模型；求解像素点颜色和α 值的关系。经典的抠图算法预假设局部像素点颜色分布模型和像素点颜色$\alpha$ 值模型，再通过采样的或传播方法拟合模型，求解$\alpha$ 值；另一些抠图算法将抠图问题视为一个半监督的学习过程，用学习的方法拟合模型求解$\alpha$值。以上方法关联像素点取至待定像素的邻域，因此又称为局部抠图算法；另根据非局部原理，存在非局部抠图算法分支，如K近邻抠图、全局采样抠图[6]等；基于卷积神经网络的抠图方法是最近较为先进的算法，也是本专利所采用的方法。

### 3、 本发明技术方案的详细阐述（重点要突出解决问题中遇到了什么困难，通过什么技术手段来解决了这个困难）
本发明主要分为四个阶段：前处理的ROI跟踪、人像前后景分离、后处理结果优化和帧间稳定以及最后的背景替换融合。下图为大概的技术框架。
![](https://raw.githubusercontent.com/mightycatty/image_bed/master/images/20191113131339.png)
#### （1）前处理：二阶指数平滑的ROI跟踪

在给定1080p的画幅中，往往人物实例仅处于中间画幅的小块区域，且一帧之间的运动幅度有限。考虑到这个特点，采用ROI跟踪的形式，将上一帧得到的结果选定一个ROI感兴趣区域，后续算法仅针对该部分ROI区域进行处理；为稳定ROI边框，防止突变和剧烈的抖动对后续算法造成影响，同时考虑平滑度与灵敏度之间的权衡，采用二阶指数平滑的方式平滑ROI的四个顶点坐标。

二阶指数平滑，是在一阶指数平滑的基础上，再一次进行指数平滑，适用于线性趋势的时间数列。假设$t$时刻的ROI坐标为$x_t$、估计坐标为$T_t$则平滑公式为：
$$
\left\{
\begin{aligned}
S_{t+1}^{1} &= \alpha*x_t + (1-\alpha)*S_{t}^{1} \\
S_{t+1}^{2} &= \beta*S_{t}^{1} + (1-\beta)*S_{t}^{2} \\
T_t &= S_{t}^{1} + S_{t}^{2}
\end{aligned}
\right.
$$

#### （2）基于卷积神经网络的人像抠图技术

基于卷积神经网络的人像前后景分离技术是当前比较流行的技术路线。通过数据推动，可以有效应对原数据中存在各种变量，得到相对传统调参式算法更鲁棒的结果。本专利采用以DeepLabv3+的基本结构思路，构建了一个精度与计算量平衡的小型卷积神经网络，并通过分离卷积、通道映射压缩以及插空卷积等方法提升模型性能和降低计算量。模型的大致拓扑结构如下：

![](https://raw.githubusercontent.com/mightycatty/image_bed/master/images/20191113135118.png)

#### （3）后处理：结果优化和运动启发的帧间平滑

上述（2）步骤中卷积神经网络的数据精度虽然已经较高，但仍存在几个问题：

1. 分割的结果虽然整体准确率很高，但局部样本仍存在瑕疵，如存在游离的误分离区域等。
2. 基于卷积神经网络的分割结果仅考虑了当前帧，因此存在帧间抖动的问题。

针对上述问题，本专利设计了一个后处理流程，主要步骤如下：

1. 针对游离脏块问题，通过连通域分析去除。考虑到具体业务场景，只保留最大连通域或者大于某个阈值的连通域。

2. 针对帧间抖动问题，尤其是边缘抖动，结合传统的运动检测算法，得到运动区域掩膜，以该掩膜引导多帧之间的卷积神经网络输出结果进行融合。

#### （4）前后背景融合

步骤（3）输出一个0到1的连续值掩膜，其中前景为1，背景为0，介乎0到1的值多存在于边缘区域，如发丝或者其他透明材质的物体上。给定原图$I$、人像构图的结果$\alpha$以及新的置换背景$B_{new}$，得到新的合成图$i$:
$$
i = \alpha*I + (1-\alpha)*B_{new}
$$


4、本发明技术方案带来的有益效果

1) 计算量和模型参数量小，低资源消耗，可以实时部署与开播的一般PC主机。

2) 基于卷积神经网络的抠图技术有较好的鲁棒性，可以应对光照变化、镜头运动以及其他因素引起的不确定干扰，得到较为稳定的构图输出。

3) 自适应的抠图技术，一定程度上可以替换绿幕构图，降低使用场景的受限程度。

4) 精度较高的人像构图，为自然的新背景合成提供可能，可以衍生更多的直播玩法。